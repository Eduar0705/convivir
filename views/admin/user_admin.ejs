<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel de administración para gestionar usuarios y configuraciones">
    <title>ConVivir - Administración</title>
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="../css/user_admin.css">
    <link rel="shortcut icon" href="../img/LOGO.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="layout">
        <aside class="sidebar" aria-label="Menú lateral">
            <div class="sidebar-header">
                <a href="/admin">
                    <div class="logo">Admin<span>Panel</span></div>
                </a>
                <button class="sidebar-toggle" aria-label="Ocultar menú" aria-expanded="true">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <nav>
                <ul>
                    <li>
                        <a href="/admin">
                            <i class="fas fa-home"></i>
                            <span>Inicio</span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/user_admin">
                            <i class="fas fa-users"></i>
                            <span>Usuarios</span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/pagos">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Pagos</span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/estadisticas">
                            <i class="fas fa-chart-bar"></i>
                            <span>Estadísticas</span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/proveedores">
                            <i class="fas fa-truck"></i>
                            <span>Proveedores</span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/avisos">
                            <i class="fas fa-bullhorn"></i>
                            <span>Avisos</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="salir">
                <a href="/">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Salir</span>
                </a>
            </div>
        </aside>

        <div class="main-content">
            <!-- Header -->
            <header class="navbar" aria-label="Menú principal">
                <div class="navbar-left">
                    <button class="menu-toggle" aria-label="Mostrar menú">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Usuarios <i class="fa fa-user"></i></h1>
                </div>
                <div class="navbar-right">
                    <div class="user-profile">
                        <i class="fas fa-user-shield"></i>
                        <span class="username">Administrador</span>
                    </div>
                </div>
            </header>
            <main class="content">
                <div class="tarjetas-panel">
                    <div class="tarjeta">
                        <div class="icono-tarjeta fondo-azul">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="info-tarjeta">
                            <h3>Usuarios Registrados</h3>
                            <p><%= avisos.length %></p>
                            <input type="text" id="buscar_cedula" name="buscar_cedula" placeholder="Buscar residentes por cédula">
                            <button id="btnBuscarCedula" type="button">Buscar <i class="fa fa-search"></i></button>
                            <button id="btnLimpiarCedula" type="button">Limpiar <i class="fa fa-eraser"></i></button>
                        </div>
                    </div>
                </div>
                <div class="agg">
                    <form class="login-form" id="loginForm" method="post" action="/regUsuario_admin" autocomplete="off">
                        <div class="form-group">
                            <label for="name">
                                <i class="fas fa-user"></i> 
                                Nombre y Apellido
                            </label>
                            <input type="text" id="name" name="name" placeholder="Ingrese su Nombre y Apellido">
                        </div>
                        <div class="form-group">
                            <label for="username">
                                <i class="fas fa-user"></i> 
                                Usuario
                            </label>
                            <input type="text" id="user" name="user" placeholder="Ingrese su Usuario">
                        </div>
                        <div class="form-group">
                            <label for="password">
                                <i class="fas fa-lock"></i> 
                                Contraseña
                            </label>
                            <input type="password" id="pass" name="pass" placeholder="Ingrese su contraseña">
                        </div>
                        <div class="form-group">
                            <label for="email">
                                <i class="fas fa-envelope"></i>
                                Correo electronico
                            </label>
                            <input type="email" id="email" name="email" placeholder="Ingrese su correo electronico">
                        </div>
                        <div class="form-group">
                            <label for="telefono">
                                <i class="fas fa-phone"></i>
                                Telefono
                            </label>
                            <input type="text" id="telefono" name="telefono" value="+58" placeholder="Ingrese su numero de telefono">
                        </div>
                        <div class="form-group">
                            <label for="cedula">
                                <i class="far fa-id-card"></i>
                                Cedula de Identidad
                            </label>
                            <input type="text" id="cedula" name="cedula" placeholder="Ej: V-,E-, J-, G- 12345678">
                        </div>
                        <div class="form-group">
                            <label for="edificio">
                                <i class="fas fa-building"></i>
                                Edificio
                            </label>
                            <select name="edificio" id="edificio" class="select">
                                <option value="A">Edificio A</option>
                                <option value="B">Edificio B</option>
                                <option value="C">Edificio C</option>
                                <option value="D">Edificio D</option>
                                <option value="Administración">Administración</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="apartamento">
                                <i class="fas fa-door-open"></i>
                                Apartamento
                            </label>
                            <select name="apartamento" id="apartamento" class="select">
                                <option >Selecione un opcion</option>
                                <option value="Administración">Administración</option>
                                <option disabled>Planta Baja</option>
                                <option value="PB-1">PB - 1</option>
                                <option value="PB-2">PB - 2</option>
                                <option value="PB-3">PB - 3</option>
                                <option value="PB-4">PB - 4</option>
                                <option disabled>Primer Piso</option>
                                <option value="1-1">1 - 1</option>
                                <option value="1-2">1 - 2</option>
                                <option value="1-3">1 - 3</option>
                                <option value="1-4">1 - 4</option>
                                <option disabled>Segundo Piso</option>
                                <option value="2-1">2 - 1</option>
                                <option value="2-2">2 - 2</option>
                                <option value="2-3">2 - 3</option>
                                <option value="2-4">2 - 4</option>
                                <option disabled>Tercer Piso</option>
                                <option value="3-1">3 - 1</option>
                                <option value="3-2">3 - 2</option>
                                <option value="3-3">3 - 3</option>
                                <option value="3-4">3 - 4</option>
                                <option disabled>Cuarto Piso</option>
                                <option value="4-1">4 - 1</option>
                                <option value="4-2">4 - 2</option>
                                <option value="4-3">4 - 3</option>
                                <option value="4-4">4 - 4</option>
                                <option disabled>Quinto Piso</option>
                                <option value="5-1">5 - 1</option>
                                <option value="5-2">5 - 2</option>
                                <option value="5-3">5 - 3</option>
                                <option value="5-4">5 - 4</option>
                                <option disabled>Sexto Piso</option>
                                <option value="6-1">6 - 1</option>
                                <option value="6-2">6 - 2</option>
                                <option value="6-3">6 - 3</option>
                                <option value="6-4">6 - 4</option>
                                <option disabled>Séptimo Piso</option>
                                <option value="7-1">7 - 1</option>
                                <option value="7-2">7 - 2</option>
                                <option value="7-3">7 - 3</option>
                                <option value="7-4">7 - 4</option>
                                <option disabled>Octavo Piso</option>
                                <option value="8-1">8 - 1</option>
                                <option value="8-2">8 - 2</option>
                                <option value="8-3">8 - 3</option>
                                <option value="8-4">8 - 4</option>
                                <option disabled>Noveno Piso</option>
                                <option value="9-1">9 - 1</option>
                                <option value="9-2">9 - 2</option>
                                <option value="9-3">9 - 3</option>
                                <option value="9-4">9 - 4</option>
                                <option disabled>Décimo Piso</option>
                                <option value="10-1">10 - 1</option>
                                <option value="10-2">10 - 2</option>
                                <option value="10-3">10 - 3</option>
                                <option value="10-4">10 - 4</option>
                                <option disabled>Onceavo Piso</option>
                                <option value="11-1">11 - 1</option>
                                <option value="11-2">11 - 2</option>
                                <option value="11-3">11 - 3</option>
                                <option value="11-4">11 - 4</option>
                                <option disabled>Penthouse</option>
                                <option value="PH-1">PH - 1</option>
                                <option value="PH-2">PH - 2</option>
                                <option value="PH-3">PH - 3</option>
                                <option value="PH-4">PH - 4</option>
                            </select>
                        </div>
                        <select name="cargo" id="cargo" class="select">
                            <option value="1">Administración</option>
                            <option value="2">Residente</option>
                        </select>
                        <button id="btnAgregarUsuario" type="submit">Agregar usuario <i class="fa fa-user-plus"></i></button>
                    </form>
                </div>
                <div class="crud">
                    <table border="1">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre y Apellido</th>
                                <th>Usuario</th>
                                <th>Correo</th>
                                <th>Telefono</th>
                                <th>Cedula</th>
                                <th>Torre</th>
                                <th>Apartamento</th>
                                <th>Cargo de Usuario</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (avisos.length > 0) { %>
                                <% avisos.forEach(function(aviso) { %>
                                    <tr>
                                        <td><%= aviso.id %></td>
                                        <td><%= aviso.nombre_apellido %></td>
                                        <td><%= aviso.usuario %></td>
                                        <td><%= aviso.email %></td>
                                        <td><%= aviso.telefono %></td>
                                        <td><%= aviso.cedula %></td>
                                        <td><%= aviso.edificio %></td>
                                        <td><%= aviso.apartamento %></td>
                                        <td><%= aviso.id_cargo === 1 ? 'Administrador' : (aviso.id_cargo === 2 ? 'Residente' : aviso.id_cargo) %></td>
                                        <td>
                                            <a href="#" 
                                                class="fa fa-trash" title="Eliminar" 
                                                onclick="if ('aviso.id_cargo === 1') {  eliminarAdmin('<%= aviso.id %>') } else { eliminarUsuario('<%= aviso.id %>')} ; return false;">
                                            </a>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="10">No hay avisos registrados.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </main>
            
            <footer class="footer">
                <p>&copy; <%= new Date().getFullYear() %> Panel de Administración. Todos los derechos reservados.</p>
            </footer>
        </div>
    </div>
    <script src="../js/script.js"></script>
    <script src="../js/user_admin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        async function eliminarUsuario(id) {
            const { isConfirmed } = await Swal.fire({
                title: '¿Eliminar usuario?',
                text: "Esta acción no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (isConfirmed) {
                try {
                    const response = await fetch('/eliminarUsuario/' + id, { method: 'GET' });
                    if (response.ok) {
                        Swal.fire('Eliminado!', 'El usuario ha sido eliminado.', 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', 'No se pudo eliminar el usuario', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Ocurrió un error al eliminar', 'error');
                }
            }
        }

        async function eliminarAdmin(id) {
            const { value: password, isConfirmed } = await Swal.fire({
                title: 'Eliminar administrador',
                text: 'Para eliminar un administrador, ingrese la clave especial:',
                icon: 'warning',
                input: 'password',
                inputPlaceholder: 'Ingrese la clave',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Confirmar eliminación',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Debe ingresar la clave';
                    }
                }
            });

            if (isConfirmed) {
                // Verificar la clave (puedes cambiarla por la que necesites)
                if (password === "admin123") {
                    try {
                        const response = await fetch('/eliminarUsuario/' + id, { method: 'GET' });
                        if (response.ok) {
                            Swal.fire('Eliminado!', 'El administrador ha sido eliminado.', 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('Error', 'No se pudo eliminar el administrador', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Ocurrió un error al eliminar', 'error');
                    }
                } else {
                    Swal.fire('Clave incorrecta', 'No tiene permisos para esta acción', 'error');
                }
            }
        }
    </script>
</body>
</html>
